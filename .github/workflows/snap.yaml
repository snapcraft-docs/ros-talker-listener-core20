name: snap
on:
  push:
    tags:
      - '*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  main-snap:
    uses: ubuntu-robotics/snap_workflows/.github/workflows/build-install-test-snap.yaml@F_add_snapcraft_channel_option
    with:
      ubuntu-image: ubuntu-20.04
      branch-name: main
      snap-name: ros-talker-listener
      snap-install-args: --devmode
      test-script: |
                    #!/bin/bash
                    
                    ## Install ROS
                    sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'

                    sudo apt install curl
                    curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo apt-key add -
                    sudo apt update
                    sudo apt install ros-noetic-ros-base

                    check_node() {
                        local node_name=$1
                        rosnode list | grep -q "/$node_name"
                        if [ $? -eq 0 ]; then
                            echo "$node_name is running."
                        else
                            echo "Error - $node_name is not running."
                            exit 1
                        fi
                    }
                    check_topic() {
                        local topic_name=$1
                        local pub_count=$(rostopic info /$topic_name | grep "Publisher count:" | awk '{print $3}')
                        local sub_count=$(rostopic info /$topic_name | grep "Subscription count:" | awk '{print $3}')
                        if [ "$pub_count" -gt 0 ] && [ "$sub_count" -gt 0 ]; then
                            echo "$topic_name has publishers and subscribers."
                        else
                            echo "Error - $topic_name has no publishers or subscribers."
                            exit 1
                        fi
                    }
                    
                    echo "sourcing"
                    source /opt/ros/noetic/setup.bash
                    
                    echo $ROS_PACKAGE_PATH
                    echo "starting ros core"
                    roscore &
                    pid=$!

                    sleep 5

                    rosnode list

                    echo "I run rosnode"
                    #  & ros-talker-listener &
                    # pid=$!
                    # rosnode list | grep -q "/talker"
                    # if [ $? -eq 0 ]; then
                    #     echo "talker is running."
                    # else
                    #     echo "Error - talker is not running."
                    #     exit 1
                    # fi
                    # check_node talker
                    # check_node listener
                    # check_topic chatter
                    kill $pid

                    echo "All checks passed successfully."
